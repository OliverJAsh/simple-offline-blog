<!DOCTYPE html>
<html>
    <head>
        <title>Blog</title>
        <meta name="viewport" content="width=device-width">
    </head>
    <body>
        <h1><a href="/">Blog</a></h1>
        <div id="js-content">Loadingâ€¦</div>
        <script>
            /* eslint-env browser */
            window.addEventListener('DOMContentLoaded', function () {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function () {
                        console.log('Service worker registered');
                    });

                var fragmentFromString = function (htmlString) {
                    return document.createRange().createContextualFragment(htmlString);
                };

                var getContentUrl = function (contentId) { return '/content/' + contentId; };

                var isContentCached = function (contentId) {
                    return caches.open('content').then(function (cache) {
                        return cache.match(getContentUrl(contentId)).then(function (response) {
                            return !! response;
                        });
                    });
                };

                var updateContent = function (fragment) {
                    var contentElement = document.querySelector('#js-content');
                    contentElement.innerHTML = '';
                    contentElement.appendChild(fragment);
                };

                // Stale-while-revalidate

                // Load patterns:
                // cache - display - network - display - END
                // no cache - network - display - END

                // Tests:
                // - Server error
                // - No cache with network
                // - No cache without network
                // - Cache
                // - Cache then update

                var fetchFromNetwork = function (url) {
                    return fetch(url).then(function (response) {
                        return { type: 'network', response: response };
                    });
                };

                var fetchFromCacheOrElseNetwork = function (url) {
                    return caches.match(url)
                        .then(function (response) {
                            return response
                                ? { type: 'cache', response: response }
                                : fetchFromNetwork(url);
                        });
                };

                var getResponses = function (url) {
                    // Cache or else network
                    var cacheOrElseNetworkPromise = fetchFromCacheOrElseNetwork(url);
                    // If first try was from cache, now try the network
                    var cacheThenNetworkPromise = cacheOrElseNetworkPromise.then(function (firstTry) {
                        if (firstTry.type === 'cache') {
                            return fetchFromNetwork(url);
                        }
                    });

                    return [
                        cacheOrElseNetworkPromise,
                        cacheThenNetworkPromise
                    ];
                };

                // Serve from cache or else network. When serving from cache,
                // fetch the newest content from the network to update the
                // content on screen and then revalidate the cache.
                // This function has side effects.
                var handlePageState = function (contentId, options) {
                    var url = getContentUrl(contentId);
                    var responses = getResponses(url);

                    var cacheOrElseNetworkPromise = responses[0];
                    var cacheThenNetworkPromise = responses[1];

                    return cacheOrElseNetworkPromise
                        .then(function (wrappedResponse) {
                            console.log('Render: from ' + wrappedResponse.type);
                            var newTreePromise = (wrappedResponse.response.ok
                                ? wrappedResponse.response.clone().json()
                                    .then(options.render)
                                : wrappedResponse.response.clone().text()
                                    .then(text => fragmentFromString('<p>' + text + '</p>')));

                            return newTreePromise
                                .then(updateContent)
                                .then(function () {
                                    if (options.shouldCache && wrappedResponse.type === 'network') {
                                        console.log('Cache: first time');
                                        return caches.open('content').then(function (cache) {
                                            return cache.put(url, wrappedResponse.response);
                                        });
                                    }
                                });
                        }, function (error) {
                            return updateContent(fragmentFromString('<p>' + error.message + '</p>'));
                        })
                        .then(function () {
                            return cacheThenNetworkPromise.then(function (wrappedResponse) {
                                if (wrappedResponse && wrappedResponse.response.ok) {
                                    console.log('Render: from ' + wrappedResponse.type);
                                    return wrappedResponse.response.clone().json()
                                        .then(options.render)
                                        .then(updateContent)
                                        .then(function () {
                                            console.log('Cache: update');
                                            return caches.open('content').then(function (cache) {
                                                return cache.put(url, wrappedResponse.response);
                                            });
                                        });
                                }
                            });
                        });
                };

                var renderHomePage = function (articles) {
                    return Promise.all(articles.map(function (article) {
                        return isContentCached('articles/' + article.id).then(function (isCached) {
                            return (
                                '<li>' +
                                    '<h2><a href="/articles/' + article.id + '">' + article.title + '</a></h2>' +
                                    (isCached ? '<p><strong>Available offline</strong></p>' : '') +
                                    '<p>' + new Date(article.date).toDateString() + '</p>' +
                                    article.body +
                                '</li>'
                            );
                        });
                    })).then(function (articleLiNodes) {
                        return fragmentFromString('<ul>' + articleLiNodes.join('') + '</ul>');
                    });
                };

                var renderArticlePage = function (article) {
                    var contentId = 'articles/' + article.id;
                    return isContentCached(contentId).then(function (isCached) {
                        var fragment = fragmentFromString(
                            '<label><input type="checkbox" ' + (isCached ? 'checked' : '') + '> Read offline</label>' +
                            '<h2><a href="/articles/' + article.id + '">' + article.title + '</a></h2>' +
                            '<p>' + new Date(article.date).toDateString() + '</p>' +
                            article.body
                        );

                        var cacheCheckboxElement = fragment.querySelector('input');
                        cacheCheckboxElement.addEventListener('change', function (event) {
                            return caches.open('content').then(function (cache) {
                                var shouldCache = event.target.checked;
                                var contentUrl = getContentUrl(contentId);
                                if (shouldCache) {
                                    return cache.add(contentUrl).catch(function () {
                                        event.target.checked = false;
                                    });
                                } else if (isCached) {
                                    cache.delete(contentUrl);
                                }
                            });
                        });

                        return fragment;
                    });
                };

                //
                // Routing
                //

                var homeRegExp = /^\/$/;
                var articleRegExp = /^\/articles\/(.*)$/;
                if (homeRegExp.test(location.pathname)) {
                    var contentId = 'articles';

                    handlePageState(contentId, {
                        shouldCache: true,
                        render: renderHomePage
                    });
                }
                else if (articleRegExp.test(location.pathname)) {
                    var contentId = 'articles/' + location.pathname.match(articleRegExp)[1];

                    handlePageState(contentId, { render: renderArticlePage });
                }
            });

        </script>
    </body>
</html>
